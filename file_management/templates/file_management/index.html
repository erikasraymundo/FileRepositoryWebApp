{% extends 'file_management/base.html' %}

{% block content %}
         <section class="file-management">
            <div class="file-management--container">


               <div class="file-management--header">
                  <h2 class="h2 text-purple">File Management</h2>
                  <div class="cta--categories">
                     <a href="" class="btn btn-black">Manage Categories</a>
                  </div>
               </div>

               <div class="file-management--categories">

                  {% for category in category_list %}
                  <div class="file-management--categories_card">
                     <div class="icon-file">
                        <svg width="20" height="25" viewBox="0 0 20 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                           <path
                              d="M13.2375 0.7375C12.7625 0.2625 12.125 0 11.4625 0H2.5C1.125 0 0 1.125 0 2.5V22.5C0 23.875 1.1125 25 2.4875 25H17.5C18.875 25 20 23.875 20 22.5V8.5375C20 7.875 19.7375 7.2375 19.2625 6.775L13.2375 0.7375ZM13.75 20H6.25C5.5625 20 5 19.4375 5 18.75C5 18.0625 5.5625 17.5 6.25 17.5H13.75C14.4375 17.5 15 18.0625 15 18.75C15 19.4375 14.4375 20 13.75 20ZM13.75 15H6.25C5.5625 15 5 14.4375 5 13.75C5 13.0625 5.5625 12.5 6.25 12.5H13.75C14.4375 12.5 15 13.0625 15 13.75C15 14.4375 14.4375 15 13.75 15ZM11.25 7.5V6.73636C11.25 4.9424 13.419 4.04398 14.6875 5.3125C15.956 6.58102 15.0576 8.75 13.2636 8.75H12.5C11.8125 8.75 11.25 8.1875 11.25 7.5Z"
                              fill="black" fill-opacity="0.5" />
                        </svg>
                     </div>
                     <h2> {{ category.title }}</h2>
                     <p class="fw-700 text-white">{{ category.file_set.count}} Files</p>
                  </div>
                  {% endfor %}

                  {% comment %} <div class="file-management--categories_grading-sheets">
                     <div class="icon-file">
                        <svg width="20" height="25" viewBox="0 0 20 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                           <path
                              d="M13.2375 0.7375C12.7625 0.2625 12.125 0 11.4625 0H2.5C1.125 0 0 1.125 0 2.5V22.5C0 23.875 1.1125 25 2.4875 25H17.5C18.875 25 20 23.875 20 22.5V8.5375C20 7.875 19.7375 7.2375 19.2625 6.775L13.2375 0.7375ZM13.75 20H6.25C5.5625 20 5 19.4375 5 18.75C5 18.0625 5.5625 17.5 6.25 17.5H13.75C14.4375 17.5 15 18.0625 15 18.75C15 19.4375 14.4375 20 13.75 20ZM13.75 15H6.25C5.5625 15 5 14.4375 5 13.75C5 13.0625 5.5625 12.5 6.25 12.5H13.75C14.4375 12.5 15 13.0625 15 13.75C15 14.4375 14.4375 15 13.75 15ZM11.25 7.5V6.73636C11.25 4.9424 13.419 4.04398 14.6875 5.3125C15.956 6.58102 15.0576 8.75 13.2636 8.75H12.5C11.8125 8.75 11.25 8.1875 11.25 7.5Z"
                              fill="black" fill-opacity="0.5" />
                        </svg>
                     </div>
                     <h2>Grading Sheets</h2>
                     <p class="fw-700 text-white">10 Files</p>
                  </div>
                  <div class="file-management--categories_other-files">
                     <div class="icon-file">
                        <svg width="20" height="25" viewBox="0 0 20 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                           <path
                              d="M13.2375 0.7375C12.7625 0.2625 12.125 0 11.4625 0H2.5C1.125 0 0 1.125 0 2.5V22.5C0 23.875 1.1125 25 2.4875 25H17.5C18.875 25 20 23.875 20 22.5V8.5375C20 7.875 19.7375 7.2375 19.2625 6.775L13.2375 0.7375ZM13.75 20H6.25C5.5625 20 5 19.4375 5 18.75C5 18.0625 5.5625 17.5 6.25 17.5H13.75C14.4375 17.5 15 18.0625 15 18.75C15 19.4375 14.4375 20 13.75 20ZM13.75 15H6.25C5.5625 15 5 14.4375 5 13.75C5 13.0625 5.5625 12.5 6.25 12.5H13.75C14.4375 12.5 15 13.0625 15 13.75C15 14.4375 14.4375 15 13.75 15ZM11.25 7.5V6.73636C11.25 4.9424 13.419 4.04398 14.6875 5.3125C15.956 6.58102 15.0576 8.75 13.2636 8.75H12.5C11.8125 8.75 11.25 8.1875 11.25 7.5Z"
                              fill="black" fill-opacity="0.5" />
                        </svg>
                     </div>
                     <h2>Other Files</h2>
                     <p class="fw-700 text-white">12 Files</p>
                  </div> {% endcomment %}
               </div>

               <div class="component1">
                  <h4 class="h4 active"><a href="{% url 'file-management:index' %}">Uploaded Files</a></h4>
                  <h4 class="h4 "><a href="{% url 'file-management:archived-index' %}">Archived</a></h4>
               </div>


               <div class="file-management--controls">
                  <div class="file-management--controls_left">
                     <div>
                        <p class="text-black text-small">Category</p>
                        <div class="component4">
                           <select id="select-category">
                              {% if category_list %}
                           
                                 <option value=0 {% if category_selected == 0 %} selected {%endif%} >All</option>

                                 {% for category in category_list %}
                                 <option value={{category.id}} {% if category_selected == category.id %} selected {%endif%}>{{category.title}}</option>
                                 {% endfor %}

                              {% else %}
                                 <option value=0 {% if category_selected == 0 %} selected {%endif%} >No categories yet</option></a>
                              {% endif %}
                           </select>
                        </div>
                     </div>
                     <div>
                        <p class="text-black text-small">Sort by</p>
                        <div class="component4">
                           <select id="select-sort">
                              <option value=1 {% if sort_selected == 1 %} selected {%endif%}>Name</option>
                              <option value=2 {% if sort_selected == 2 %} selected {%endif%}>Category</option>
                              <option value=3 {% if sort_selected == 3 %} selected {%endif%}>Uploader</option>
                              <option value=4 {% if sort_selected == 4 %} selected {%endif%}>Latest Upload</option>
                              <option value=5 {% if sort_selected == 5 %} selected {%endif%}>Earliest Upload</option>
                           </select>
                        </div>
                     </div>
                     <div>
                        <p class="text-black text-small">Date uploaded</p>
                        <div class="component2">
                           <div class="start-date">
                              <input type="text" id="datepicker-start" readonly value="{{from_date}}">
                           </div>
                           -
                           <div class="end-date">
                              <input type="text" id="datepicker-end" readonly disabled value="{{to_date}}">
                           </div>
                        </div>
                     </div>
                  </div>
                  <div class="file-management--controls_right">
                     <div class="component3">
                        <div class="icon">
                           <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                              xmlns="http://www.w3.org/2000/svg">
                              <path
                                 d="M10.9167 9.66667H10.2583L10.025 9.44167C10.8417 8.49167 11.3333 7.25833 11.3333 5.91667C11.3333 2.925 8.90833 0.5 5.91667 0.5C2.925 0.5 0.5 2.925 0.5 5.91667C0.5 8.90833 2.925 11.3333 5.91667 11.3333C7.25833 11.3333 8.49167 10.8417 9.44167 10.025L9.66667 10.2583V10.9167L13.8333 15.075L15.075 13.8333L10.9167 9.66667ZM5.91667 9.66667C3.84167 9.66667 2.16667 7.99167 2.16667 5.91667C2.16667 3.84167 3.84167 2.16667 5.91667 2.16667C7.99167 2.16667 9.66667 3.84167 9.66667 5.91667C9.66667 7.99167 7.99167 9.66667 5.91667 9.66667Z"
                                 fill="#AAAAAA" />
                           </svg>
                        </div>
                        <input id="search" type="text" class="search-input" placeholder="Search" value="{{ search_value }}">
                     </div>
                     <div class="btn-dark">
                        <a href="{%url 'file-management:openUploadView' %}"> <span class="iconify" data-icon="ic:baseline-upload"></span> Upload File</a>
                     </div>
                  </div>
               </div>

               <div class="file-management--table-container">
                  
                  {% if file_list %}
                  <table>
                     <thead>
                        <tr>
                           <th scope="col">Name</th>
                           <th scope="col">Category</th>
                           <th scope="col">Uploader</th>
                           <th scope="col">Uploaded</th>
                           <th scope="col">Actions</th>
                        </tr>
                     </thead>
                     <tbody>
                        {% for file in file_list %}
                        
                        <tr class=".file-row">
                           <td data-label="Name" data-fileid={{file.id}}> {{ file.getNewFileName }} </td>
                           <td data-label="Category" data-fileid={{file.id}}> {{ file.category_id.title }} </td>
                           <td data-label="Uploader" data-fileid={{file.id}}> {{ file.user_id.full_name }}</td>
                           <td data-label="Uploaded" data-fileid={{file.id}}> {{ file.created_at }} </td>
                           <td data-label="Actions" class="actions">
                              <div class="actions--container">
                                 
                                 <div class="icon-view" title="view" data-fileid={{file.id}}
                                    data-filename={{file.getNewFileName}}
                                 data-fileurl={{file.url.url}} data-filetype={{file.getFileType}}>
                                    <svg width="18" height="11" viewBox="0 0 18 11" fill="none"
                                       xmlns="http://www.w3.org/2000/svg">
                                       <path fill-rule="evenodd" clip-rule="evenodd"
                                          d="M8.9591 10.6003C13.7672 10.6003 17.7612 5.90558 17.7612 5.90558C18.0735 5.57119 18.0823 5.01894 17.771 4.68183C17.771 4.68183 13.9745 0 9.00058 0C4.02663 0 0.230156 4.68183 0.230156 4.68183C-0.0768227 5.02334 -0.078417 5.57761 0.23558 5.91069C0.23558 5.91069 4.15112 10.6002 8.9592 10.6002L8.9591 10.6003ZM9.00059 9.04143C11.0609 9.04143 12.731 7.36646 12.731 5.30023C12.731 3.23403 11.0608 1.55904 9.00059 1.55904C6.94022 1.55904 5.2702 3.2341 5.2702 5.30023C5.2702 7.36644 6.94032 9.04143 9.00059 9.04143ZM9.00059 6.96298C9.91625 6.96298 10.6586 6.21857 10.6586 5.30028C10.6586 4.382 9.91628 3.63749 9.00059 3.63749C8.08492 3.63749 7.34252 4.382 7.34252 5.30028C7.34252 6.21857 8.08492 6.96298 9.00059 6.96298Z"
                                          fill="#777777" />
                                    </svg>
                                 </div>
                                  
                                 <a href="{% url 'file-management:download' file.id %}">
                                 <div class="icon-download" title="download">
                                    <svg width="12" height="13" viewBox="0 0 12 13" fill="none"
                                       xmlns="http://www.w3.org/2000/svg">
                                       <path
                                          d="M11.25 4.75H8.25V0.25H3.75V4.75H0.75L6 10L11.25 4.75ZM0.75 11.5V13H11.25V11.5H0.75Z"
                                          fill="#777777" />
                                    </svg>
                                 </div>
                              </a>
                                    <a href="{% url 'file-management:openEditView' file.id %}">
                                    <div class="icon-pen" title="Edit">
                                          <svg width="14" height="14" viewBox="0 0 14 14" fill="none"
                                             xmlns="http://www.w3.org/2000/svg">
                                             <path
                                                d="M0.25 10.9375V13.75H3.0625L11.3575 5.45504L8.545 2.64254L0.25 10.9375ZM13.5325 3.28004C13.825 2.98754 13.825 2.51504 13.5325 2.22254L11.7775 0.467544C11.485 0.175044 11.0125 0.175044 10.72 0.467544L9.3475 1.84004L12.16 4.65254L13.5325 3.28004Z"
                                                fill="#272727" fill-opacity="0.5" />
                                          </svg>
                                    </div>
                                    </a>
                                 <div class="icon-archive" title="Archive" id="archive" data-fileid={{file.id}} data-filename="{{file.getNewFileName}}">
                                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none"
                                       xmlns="http://www.w3.org/2000/svg">
                                       <path
                                          d="M13.405 1.9225L12.3625 0.6625C12.16 0.4075 11.8525 0.25 11.5 0.25H2.5C2.1475 0.25 1.84 0.4075 1.63 0.6625L0.595 1.9225C0.3775 2.1775 0.25 2.515 0.25 2.875V12.25C0.25 13.075 0.925 13.75 1.75 13.75H12.25C13.075 13.75 13.75 13.075 13.75 12.25V2.875C13.75 2.515 13.6225 2.1775 13.405 1.9225ZM7 11.125L2.875 7H5.5V5.5H8.5V7H11.125L7 11.125ZM1.84 1.75L2.4475 1H11.4475L12.1525 1.75H1.84Z"
                                          fill="#272727" fill-opacity="0.5" />
                                    </svg>
                                 </div>
                              </div>
                           </td>
                        </tr>
                        {% endfor %}
                     </tbody>
                  </table>
                  {% else %}
                  <p class="placeholder-not-found">No files yet</p>
                  {% endif %}
               </div>

               <div class="btn-dark">
                  <a href=""><span class="iconify" data-icon="akar-icons:paper" style="color: white;"></span>Print to
                     PDF</a>
               </div>

               <div class="modal">
                  <div class="modal-backdrop" id="modal-view-backdrop" title="close"></div>
                  <div class="view-file-modal" id="modal-view">
                     <div class="header">
                        <h4 class="text-purple fw-800" id="modal-filename">FileName.jpg</h4>
                        <span class="close-modal-icon" id="close-modal-view">
                           <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="#323232"/>
                           </svg>
                        </span>
                     </div>
                      <div class="file--container"> 
                           <!-- <h4 class="text-white">Preview</h4> -->
                      </div>
                      <div class="holder" style="margin: 1.5rem 0 0 0;display: flex;justify-content: center;">
                        <div class="btn-dark" id="modal-download-button">
                           <a><span class="iconify" data-icon="ic:baseline-download"></span>Download File</a>
                       </div>
                     </div>
                  </div>
                  <div class="holder">
                     
                  </div>
               </div>

            </div>
         </section>

         

   <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
   <script>

      {% if success == 1%}
      Swal.fire({
         icon: 'success',
         title: "File has been successfully uploaded!"
      })

      window.history.pushState('somedata', 'Title', '/file-management/');

      {% elif success == 2%}
      Swal.fire({
         icon: 'success',
         title: "File has been successfully updated!"
      })

      {% elif success == 3%}
      Swal.fire({
         icon: 'success',
         title: "File has been successfully archived!"
      })

      window.history.pushState('somedata', 'Title', '/file-management/');
      {% endif %}


      var fromDateObject, fromDateString;
      var toDateObject, toDateString;

      $("#datepicker-start").datepicker({
         maxDate: 0,
         dateFormat: 'yy-mm-dd',
         onSelect: function(dateText, inst) {
            fromDateObject = $(this).datepicker('getDate'); //the getDate method
            $("#datepicker-end").val("");
            $("#datepicker-end").prop("disabled", false);
            
            $("#datepicker-end").datepicker("destroy");
            $("#datepicker-end").datepicker({
               minDate: fromDateObject,
               maxDate: new Date(),
               dateFormat: 'yy-mm-dd',
               onSelect: function(dateText, inst) {
                  toDateObject = $(this).datepicker('getDate'); //the getDate method
                  window.location.href = getUrlMask();
               }
            });
         }
      });

      function getUrlForFilter1() {
         fromDateText = $('#datepicker-start').val();
         toDateText = $('#datepicker-end').val();
         console.log(fromDateText);

         if (toDateText == '') {
            const date = new Date();
            var y = date.getFullYear();
            var m = ("0"+(date.getMonth()+1)).slice(-2);
            var d = ("0"+date.getDate()).slice(-2);

            toDateText = y + "-" + m + "-" + d;
         }

         var category = $("#select-category").val();
         var sort = $("#select-sort").val();

         var url_mask = "{% url 'file-management:filter1' 111111 222222 'date1' 'date2' %}"
         .replace(/111111/, category)
         .replace(/222222/, sort)
         .replace(/date1/, fromDateText)
         .replace(/date2/, toDateText);

         return url_mask;
      }
      
      function getUrlForFilter2() {
      console.log("hello! " + url_mask);
         fromDateText = $('#datepicker-start').val();
         toDateText = $('#datepicker-end').val();
         console.log(fromDateText);

         if (toDateText == '') {
            const date = new Date();
            var y = date.getFullYear();
            var m = ("0"+(date.getMonth()+1)).slice(-2);
            var d = ("0"+date.getDate()).slice(-2);

            toDateText = y + "-" + m + "-" + d;
         }

         var category = $("#select-category").val();
         var sort = $("#select-sort").val();
         var query = $("#search").val();

         var url_mask = "{% url 'file-management:filter2' 111111 222222 'date1' 'date2' 'query' %}"
                        .replace(/111111/, category)
                        .replace(/222222/, sort)
                        .replace(/query/, query)
                        .replace(/date1/, fromDateText)
                        .replace(/date2/, toDateText);

         return url_mask;
      }

      function getUrlMask() {
         var url_mask;

         if ($("#search").val() == '') {
            url_mask = getUrlForFilter1();
         } else {
            url_mask = getUrlForFilter2();
         }

         return url_mask;
      }

      $('#search').keypress(
         function(e){
            if (e.which == 13) {
              window.location.href = getUrlMask();
            }
      });

      $(document).on('click', '#archive', function() {
             
         var file_name = $(this).data("filename");
         var file_id = $(this).data("fileid");

         Swal.fire({
            icon: 'warning',
            title: 'Do you want to archive ' + file_name +'?',
            showDenyButton: true,
            confirmButtonText: 'Yes, archive',
            denyButtonText: `Cancel`,
            }).then((result) => {
            if (result.isConfirmed) {
               var location = "{% url 'file-management:archive' 0 %}".replace(0, file_id);
               window.location.href = location;
            } else if (result.isDenied) {

            }
            });
      });
          
      $("td:not(:last-child)").on('click', function() { 
         const file_id = $(this).data("fileid");

         if(modal.classList.contains('show-modal') == false) {
            const location = "{% url 'file-management:detail' 0 %}".replace(0, file_id);
            window.location.href = location;
            
         }

      }); 

      $("#select-sort").change(function() {
         window.location.href = getUrlMask();
      });

      $("#select-category").change(function() {
         window.location.href = getUrlMask();
      });

      const modal = document.querySelector('#modal-view');
      const shadow = document.querySelector('#modal-view-backdrop');
      const toggle = document.querySelector('.icon-view');
      const closeBtn = document.querySelector('#close-modal-view');
      const body = document.querySelector('body');
      var selectedFileId;
            
      $(".icon-view").on('click', function() { 
         
         var file_id = $(this).data("fileid");
         var file_name = $(this).data("filename");
         var file_url = $(this).data("fileurl");
         var file_type = $(this).data("filetype");
         selectedFileId = file_id;
         
         $("#modal-filename").html(file_name);

         switch(file_type){
            case 1:
               $(".file--container").html("<img src='"+file_url+"'>");
               setupModal();
               break;

            case 2:
               $(".file--container").html("<video controls='controls' src='"+file_url+"'>");
               setupModal();
               break;

            case 3:
               var link = "{% url 'file-management:pdf_view' 0 %}".replace("0", file_id)
               window.open(link);
               break;
            
            default:
               var link = "{% url 'file-management:download' 0 %}".replace("0", file_id)
               window.open(link);
               break;
         }

         }
      ); 

      $("#modal-download-button").on('click', function() {
         var link = "{% url 'file-management:download' 0 %}".replace("0", selectedFileId);
         window.open(link);
      });
      
      $(".file--container").on('click', function() {
         var link = "{% url 'file-management:detail' 0 %}".replace("0", selectedFileId);
         window.location.href = link;
      });

      function setupModal() {
         if(modal.classList.contains('show-modal')){
         modal.classList.remove('show-modal');
         shadow.classList.remove('shadow-modal');
         body.style.overflow = "unset";
         }
         else{
         modal.classList.add('show-modal');
         shadow.classList.add('shadow-modal');
         body.style.overflow = "hidden";
         }
      }

      shadow.addEventListener('click',function(){
            modal.classList.remove('show-modal');
            shadow.classList.remove('shadow-modal');
            body.style.overflow = "unset";
      });
      
      closeBtn.addEventListener('click',function(){
            modal.classList.remove('show-modal');
            shadow.classList.remove('shadow-modal');
            body.style.overflow = "unset";
      });

    
   </script>

  



{% endblock %}