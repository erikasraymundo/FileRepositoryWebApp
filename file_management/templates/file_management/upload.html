{% extends 'file_management/base.html' %}

{% block content %}
<section class="file-management">
   <div class="file-management--container">
      <h1 class="h1">Uploading a File</h1>

      <form id="my_form" method="POST" action="{% url 'file-management:upload' %}" enctype="multipart/form-data">
         {% csrf_token %}
         <div class="container">
            <div class="columns">
               <div class="column">
                  <input id="name" class="input" type="text" placeholder="Text input" name="name" value={{ name }}>
               </div>
               <div class="column">
                  <input id="file" class="input" type="file" placeholder="Text input" name="file">
               </div>
            </div>

            <div class="columns">
               <div class="column">
                  <select name="category_id" id="category">
                     {% if category_list %}
                     {% for category in category_list %}
                     <option value="{{category.id}}" {% if category_id == category.id %} selected {%endif%} >{{category.title}}</option>
                     {% endfor %}
                     {% else %}
                     <option value="0">No categories yet</option></a>
                     {% endif %}
                  </select>
               </div>
            </div>
            <div class="columns">
               <div class="column">
                  <textarea class="textarea" placeholder="e.g. Hello world" name="description">{{ description }}</textarea>
               </div>
            </div>
            <div class="columns">
               <div class="column">
                  <button class="button is-dark">Cancel</button>
                  <button class="button is-dark" type="submit">Upload File</button>
               </div>
            </div>
         </div>
      </form>


   </div>
</section>


<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>

   
   var alreadyPrompted = false;
   var error = {{error}};


   $(document).ready(function () {

      console.log("already prompted = " + alreadyPrompted);
      console.log("error 1= " + error);
      if (alreadyPrompted == false) {
         if (error == 1) {
            Swal.fire({
               title: "That file name is already in used.",
               buttons: false
            })

      console.log("error 2= " + error);
            console.log("already prompted2 = " + alreadyPrompted);
            alreadyPrompted = true;
         }

      console.log("error 3 " + error);
         console.log("already prompted3 = " + alreadyPrompted);
      }

      console.log("error 4= " + error);
      console.log("already prompted4 = " + alreadyPrompted);

      $("#my_form").submit(function(e){
         var name = $("#name").val();
         var file_length = $("#file").get(0).files.length;
         var file_size = $("#file").get(0).files[0].size;
         var category = $("#category").val();

         if (name.trim() == "") {
            Swal.fire({
               icon: 'error',
               title: "Please enter a valid file name."
            })
            return false;
         } else if (file_length == 0) {
            Swal.fire({
               icon: 'error',
               title: "Ooops, you forgot to select a file!"
            })
            
            return false;
         } else if (file_size > 524288000) {
            Swal.fire({
               icon: 'error',
               title: "Your file is too big, please no more than 500mb!"
            })
            return false;
         } else if (category == "0") {
            Swal.fire({
               icon: 'error',
               title: "Please select a valid category."
            })
            
            return false;
         }
         
         Swal.fire({
            title: "Your file is being uploaded.",
            buttons: false
         })
         return true;
      });
   });
</script>

{% endblock %}