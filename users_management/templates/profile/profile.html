{% extends 'profile/base.html' %}

{% block content %}
{% load static %}
{% for detail in details %}
   <h1 class="h1">My Profile</h1>
   <section class="my-profile">
      <div class="my-profile--container">
            <div class="my-profile--image">
               <form enctype="multipart/form-data" method='POST' action='{%url "UploadProfilePicture" %}' id='formToUploadProfilePic'>
                  {% csrf_token %}
                  <input type='file' style='display:none' id='uploadProfilePic' accept='image/*' name='image'>
               <input type='text' value=" {{ detail.is_superuser }}" style='display:none' id='ForCheckingIfAdmin'>
               <input type='text' value=" {{ detail.pk }}" style='display:none' name='ID'>
               <input type='text' value=" {{ detail.username }}" style='display:none' id='initialUsername'>
               <input type='text' value=" {{ detail.first_name }}" style='display:none' id='initialfirstname'>
               <input type='text' value=" {{ detail.middle_name }}" style='display:none' id='initialmiddleName'>
               <input type='text' value=" {{ detail.last_name }}" style='display:none' id='initiallastname'>
               <input type='text' value=" {{ detail.address }}" style='display:none' id='initialaddress'>
               <input type='text' value=" {{ bday }}" style='display:none' id='initialbday'>
               <input type='text' value=" {{ detail.email }}" style='display:none' id='initialemail'>
               </form>
               <input type='text' value=" {{ detail.image.url }}" style='display:none' id='holderOfImageFromDB'>
               <img src="" alt="profile-image-large" id='ChangeThisToProfilePicture'>
               <h4 class="h4"> 
                  {{ detail.username }}
               </h4>
               <p>username</p>
            </div>
            <div class="my-profile--info">
               <div class="my-profile--info-container">
                     <div class="text">
                        <h4 class="h4">Personal Information</h4>
                        <table>
                           <tbody>
                              <tr>
                                    <td class="fw-700 title">Name</td>
                                    <td class="fw-400">{{ detail.first_name }} {{ detail.last_name }}</td>
                              </tr>
                              <tr>
                                    <td class="fw-700 title">Gender</td>
                                    <td id='renaethisforgender' class="fw-400"></td>
                              </tr>
                              <tr>
                                    <td class="fw-700 title">Birthdate</td>
                                    <td class="fw-400">{{ detail.birthdate }}</td>
                              </tr>
                              <tr>
                                    <td class="fw-700 title">Address</td>
                                    <td class="fw-400">{{ detail.address }}</td>
                              </tr>
                           </tbody>
                        </table>

                        <h4 class="h4">Contact Information</h4>
                        <table>
                        <tbody>
                           <tr>
                                 <td class="fw-700 title">Email</td>
                                 <td class="fw-400">{{ detail.email }}</td>
                           </tr>
                        </tbody>
                        </table>

                        <h4 class="h4">Account Details</h4>
                        <table>
                        <tbody>
                           <tr>
                                 <td class="fw-700 title">Joined since</td>
                                 <td class="fw-400">{{ detail.date_joined }}</td>
                           </tr>
                           <tr>
                                 <td class="fw-700 title">Last updated</td>
                                 <td class="fw-400">{{ detail.updated_at }}</td>
                           </tr>
                        </tbody>
                        </table>

                     </div>
                     <div>
                        <a class="btn-black" onclick='openModalForEditAccount()'>Edit Profile</a>
                     </div>
               </div>
               <div class="cta-holder">
                     <a class="btn-black" onclick='openModalForChangePassword()'>Change Password</a>
                     <a class="btn-black" id='DeleteAdminAccountButton'>Delete Account</a>
               </div>
            </div>
      </div>
   
   <div class="modal-container" id='ModalForChangePasswordOfAdmin' style='display:none'>
      <div class="modal-backdrop"></div>
      <div class="change-password-modal">
         <div class="header">
            <h4 class="text-purple fw-800">Change Password</h4>
            <span class="close-icon" id='closeModalForChangePasswordOfAdmin'>
               <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M14 1.41L12.59 0L7 5.59L1.41 0L0 1.41L5.59 7L0 12.59L1.41 14L7 8.41L12.59 14L14 12.59L8.41 7L14 1.41Z" fill="#323232"/>
               </svg>
            </span>
         </div>
         <form action="{% url 'UpdatePassword' %}" method="POST" id='FORMUpdateAdminPassword'>
            {% csrf_token %}
            <div class="row">
               <div class="col-12">
                  <input type="password" placeholder='Enter Current Password' id='FCurrPassword'>
               </div>
            </div>
            <div class="row">
               <div class="col-12">
                  <input type="password" name='newPassword' placeholder='Enter New Password'  id='FNewPassword'>
               </div>
            </div>
            <div class="row">
               <div class="col-12">
                  <input type="password"  placeholder='Confirm New Password'  id='FNew2Password'>
               </div>
            </div>
            <div class="row">
               <div class="col-12">
                  <a class="btn-black" onclick='updatePassword("{{detail.password}}")'>Save</a>
               </div>
            </div>
         </form>
      </div>
   </div>
   
   <div class="modal-container" id='ModalForEditingAdminProfilePo' style='display:none'>
      <div class="modal-backdrop"></div>
      <div class="change-password-modal">
         <div class="header">
            <h4 class="text-purple fw-800">Edit Account</h4>
            <span class="close-icon" id='closeModalForEditingAdminProfilePo'>
               <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M14 1.41L12.59 0L7 5.59L1.41 0L0 1.41L5.59 7L0 12.59L1.41 14L7 8.41L12.59 14L14 12.59L8.41 7L14 1.41Z" fill="#323232"/>
               </svg>
            </span>
         </div>
         <form action="{% url 'UpdateAccountDetails' %}" method="POST" id='FormEditUserAccounts'>
            {% csrf_token %}
            <input type='text' value='{{detail.pk}}' style='display:none' name='DeleteID'>
            <div class="row">
               <div class="col-12">
                  <label for='editUserAccountUsername'> Username </label>
                  <input type="text" name='username' id='editUserAccountUsername' value='{{ detail.username }}'>
               </div>
            </div>
            <div class="row">
               <div class="col-12">
                  <label for='editUserAccountUsername'> First Name </label>
                  <input type="text" name='first_name' id='editUserFirstName' value='{{ detail.first_name }}'>
               </div>
            </div>
            <div class="row">
               <div class="col-12">
                  <label for='editUserAccountUsername'> Middle Name </label>
                  <input type="text" name='middle_name' id='editUserMiddleName' value='{{ detail.middle_name }}'>
               </div>
            </div>
            <div class="row">
               <div class="col-12">
                  <label for='editUserAccountUsername'> Last Name </label>
                  <input type="text" name='last_name' id='editUserLastName' value='{{ detail.last_name }}'>
               </div>
            </div>
            <div class="row">
               <div class="col-12">
                  <label for='editUserAccountUsername'> Address </label>
                  <input type="text" name='address' id='editUserAccountAddress' value='{{ detail.address }}'>
               </div>
            </div>
            <div class="row">
               <div class="col-12">
                  <label for='editUserAccountUsername'> Email Address </label>
                  <input type="email" name='email' id='editUserAccountEmail' value='{{ detail.email }}'>
               </div>
            </div>
            <div class="row">
               <div class="col-12">
                  <label for='editUserAccountUsername'> Birth Day </label>
                  <input type="date" name='bday' id='bDay' value='{{ bday }}'>
               </div>
            </div>
            <input type="text" name='asd' id='hiddeGender' value='{{ detail.gender }}' style='display:none'>
            <fieldset class="gender" id="group" name='gender'>
               <div>
                   <input type="radio" id="Woman" name="group" value="1"
                         >
                   <label for="Woman">Woman</label>
                 </div>
                 <div>
                   <input type="radio" id="Man" name="group" value="2">
                   <label for="Man">Man</label>
                 </div>
                 <div>
                   <input type="radio" id="Others" name="group" value="3">
                   <label for="Others">Others</label>
                 </div>
           </fieldset>
            <p style='text-align: center; color:red; visibility: hidden; display:block' id='ErrorMessageSenderEditUserAccountCurrent'></p>
            <div class="row">
               <div class="col-12">
                  <a class="btn-black" onclick='updateUserAccount( {{ username }} )'>Save Changes</a>
               </div>
            </div>
         </form>
      </div>
   </div>
   <form action='{% url "DeleteAccount" %}' id='ProceedDeletionOfAdminAccount', method="POST">
      {% csrf_token %}
      <input type='text' value='{{detail.pk}}' style='display:none' name='DeleteID'>
   </form>

<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>

   //for gender (edit)
   if(document.getElementById('hiddeGender').value == 1){
      document.getElementById('Woman').checked = true;
      document.getElementById('renaethisforgender').textContent = 'Woman';
   }
   else if (document.getElementById('hiddeGender').value == 2){
      document.getElementById('Man').checked = true;
      document.getElementById('renaethisforgender').textContent = 'Man';
   }
   else{
      document.getElementById('Others').checked = true;
      document.getElementById('renaethisforgender').textContent = 'Others';
   }

   //end gender
   document.getElementById('ChangeThisToProfilePicture').style.width = '250px';
   document.getElementById('ChangeThisToProfilePicture').style.height = '250px';
   document.getElementById('ChangeThisToProfilePicture').style.objectFit = 'cover';
   document.getElementById('ChangeThisToProfilePicture').style.borderRadius = '50%';
   if(document.getElementById('holderOfImageFromDB').value == ' None'){
      document.getElementById('ChangeThisToProfilePicture').src = "{% static 'src/images/profile-image-large.png' %}";
   }else{
      document.getElementById('ChangeThisToProfilePicture').src = document.getElementById('holderOfImageFromDB').value;
    
   }

   //uplaod profile picture
   document.getElementById('ChangeThisToProfilePicture').onclick = function(e){
      document.getElementById('uploadProfilePic').click();
   }

   document.getElementById('uploadProfilePic').onchange = function(e){
      //upload sa Database
      Swal.fire({
         icon: 'success',
         allowOutsideClick: false,
         title: "Your display picture has been changed successfully.",
         confirmButtonText: 'Great',
      }).then(() => {
         document.getElementById('formToUploadProfilePic').submit()
      })
   }

   ///////////////////////

   document.getElementById('closeModalForChangePasswordOfAdmin').style.cursor = 'pointer';
   document.getElementById('closeModalForEditingAdminProfilePo').style.cursor = 'pointer';
   /////////

   function openModalForChangePassword(){
    document.getElementById('ModalForChangePasswordOfAdmin').style.display = 'block';
    document.getElementById('FCurrPassword').value = '';
    document.getElementById('FNewPassword').value = '';
    document.getElementById('FNew2Password').value = '';
   }

   document.getElementById('closeModalForChangePasswordOfAdmin').onclick = function(e){ 
      document.getElementById('ModalForChangePasswordOfAdmin').style.display = 'none';
   }

   var initialusername = document.getElementById('editUserAccountUsername').value;
   var initialfirstname = document.getElementById('editUserFirstName').value;
   var initiallastname = document.getElementById('editUserLastName').value;
   var initialaddress = document.getElementById('editUserAccountAddress').value;
   var initialemail = document.getElementById('editUserAccountEmail').value;
   var initialmiddleName = document.getElementById('editUserMiddleName').value;
   var initialbday = document.getElementById('bDay').value;
   function openModalForEditAccount(){
      document.getElementById('editUserAccountUsername').value = initialusername;
      document.getElementById('editUserFirstName').value = initialfirstname;
      document.getElementById('editUserLastName').value = initiallastname;
      document.getElementById('editUserAccountAddress').value = initialaddress;
      document.getElementById('editUserAccountEmail').value = initialemail;
      document.getElementById('editUserMiddleName').value - initialmiddleName;
      document.getElementById('bDay').value = initialbday;
      document.getElementById('ModalForEditingAdminProfilePo').style.display = 'block';
     }
  
     document.getElementById('closeModalForEditingAdminProfilePo').onclick = function(e){ 
        document.getElementById('ModalForEditingAdminProfilePo').style.display = 'none';
     }

   function updatePassword(currentPassword){
      var curr = document.getElementById('FCurrPassword').value;
      var newPass = document.getElementById('FNewPassword').value;
      var newPass2 = document.getElementById('FNew2Password').value;

      //check if all are not blank
      if(curr == '' || newPass == '' || newPass2 == ''){
         Swal.fire({
            icon: 'error',
            title: "All fields are required.",
            confirmButtonText: 'Ok',
         })
      }else{
         if(curr == currentPassword){
            if(newPass == newPass2){
            //Save to Database
            Swal.fire({
               icon: 'success',
               allowOutsideClick: false,
               title: "Your passwords has been changed successfully.",
               confirmButtonText: 'Great',
            }).then (() => {
               document.getElementById('FORMUpdateAdminPassword').submit();
            })
            }else{
               Swal.fire({
                  icon: 'error',
                  title: "Your passwords does not match.",
                  confirmButtonText: 'Ok',
               })
            }
         }else{
            Swal.fire({
               icon: 'error',
               title: "Incorrect current password.",
               confirmButtonText: 'Ok',
            })
      }
   }
   }

   document.getElementById('DeleteAdminAccountButton').onclick = function(e){
      var isAdmin = document.getElementById('ForCheckingIfAdmin').value;

      if(isAdmin){
         Swal.fire({
            icon: 'error',
            title: "Cannot delete an administrator account",
            confirmButtonText: 'Ok',
         })
      }else{
         Swal.fire({
            icon: 'warning',
            showCancelButton: true,
            title: "Are you sure you want to delete your account?",
            confirmButtonText: 'Yes',
            cancelButtonText: 'Cancel',
         }).then((result) => {
            if(result.isConfirmed){
               document.getElementById('ProceedDeletionOfAdminAccount').submit();
            }
         })
      }
    
   }

   function updateUserAccount(listOfUsernames){
      var username = document.getElementById('editUserAccountUsername').value;
      var firstname = document.getElementById('editUserFirstName').value;
      var lastname = document.getElementById('editUserLastName').value;
      var address = document.getElementById('editUserAccountAddress').value;
      var email = document.getElementById('editUserAccountEmail').value;
      var middleName = document.getElementById('editUserMiddleName').value;
      // Validate
      if(username == '' || firstname == '' || lastname == '' || address == ''  || middleName == '' || email == ''){
         Swal.fire({
            icon: 'warning',
            title: "All fields are required",
            confirmButtonText: 'Ok',
         })
      }else{
      //validate email
      var re = /\S+@\S+\.\S+/;
       if(re.test(email)){
         //check if username is duplicated
         var isDuplicate = false;
         for(var i = 0 ; i < listOfUsernames.length; i++){
         if(i+1 == listOfUsernames.length){
         //last index
         if(listOfUsernames[i] == username){
            isDuplicate = true;
         }
         if(!isDuplicate){
         //Save To DB
         Swal.fire({
            icon: 'success',
            allowOutsideClick: false,
            title: "Your profile has been updated.",
            confirmButtonText: 'Great',
         }).then (() => {
            document.getElementById('FormEditUserAccounts').submit();
         })
         }else{
        //Error Message
         Swal.fire({
           icon: 'error',
           title: "Username is already taken.",
           confirmButtonText: 'Ok',
        })
        }
         }else{
          if(listOfUsernames[i] == username){
            isDuplicate = true;
          }
          }
         }
       }else{
         Swal.fire({
            icon: 'warning',
            title: "Invalid Email Address",
            confirmButtonText: 'Ok',
         })
       }

         
      }
   }
</script>
  
 {% endfor %}
   </section>
{% endblock %}
